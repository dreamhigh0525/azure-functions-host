<ng-include src="'app/views/shared/breadcrumb.html'"></ng-include>
<div class="row">
    <div ng-if="!model" class="col-md-9">Loading...</div>
    <div ng-if="model" class="col-md-9">
        <h3>
            Invocation Details <small ng-bind="model.invocation.functionDisplayTitle"></small>
        </h3>

        <p>
            <a class="btn btn-primary" href="{{_urls.replayFunction(invocationId)}}">Replay function</a>
        </p>

        <div ng-if="isRunning(model.invocation)">
            <form action="{{_api.sdk.abortFunctionInstance(invocationId)}}" method="POST" class="form-inline">
                <button ng-if="!model.invocation.isAborted" class="btn btn-danger btn-sm" type="submit"><span class="glyphicon glyphicon-remove"></span> Abort Host</button>
                <button ng-if="model.invocation.isAborted" class="btn btn-danger btn-sm" disabled>Host abort requested</button>
            </form>
        </div>
        <p ng-class="model.invocation.getAlertClass()" class="alert">
            <b>{{model.invocation.getLabelText()}}</b>
            <span ng-bind="model.invocation.statusTimeString"></span> <small ng-if="model.invocation.durationString">({{model.invocation.durationString}} running time)</small>
            <div ng-if="model.invocation.exceptionMessage">
                <span>
                    <b>{{model.invocation.exceptionType}}</b>: {{model.invocation.exceptionMessage}}
                </span>
            </div>
        </p>
        <p>
            <span class="glyphicon glyphicon-flash"></span><span ng-bind="model.trigger"></span>
            <span ng-if="model.ancestor"> on <a title="The parent job which triggered this function" href="{{_urls.functionInvocation(model.ancestor.id)}}">{{model.ancestor.functionDisplayTitle}} {{ancestor.id}}</a></span>
        </p>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th class="col-md-2">Parameter</th>
                    <th class="col-md-3">Value</th>
                    <th class="col-md-4">Notes</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-if="model.parameters.length === 0">
                    <td colspan="3">The function has no parameters.</td>
                </tr>
                <tr ng-repeat="param in model.parameters">
                    <td><b>{{param.name}}</b></td>
                    <td>
                        <span ng-if="!param.extendedBlobModel">{{param.argInvokeString}}</span>
                        <span ng-if="param.extendedBlobModel.isBlobMissing">{{param.argInvokeString}} - (The blob does not exist).</span>
                        <span ng-if="isParamOwnedSomeoneElse(param)" title="The existing blob was not generated by the current function invocation." class="glyphicon glyphicon-exclamation-sign not-running"></span>
                        <a ng-if="param.extendedBlobModel && !param.extendedBlobModel.isBlobMissing" href="{{_api.sdk.blob(param.argInvokeString)}}api">{{param.argInvokeString}}</a>
                        <section ng-if="isParamOwnedAnotherFunction(param)">
                            <br /><br />
                            <span>
                                The blob was generated by another
                                <a href="sdfsd">function invocation</a>
                            </span>
                        </section>
                    </td>
                    <td>
                        {{param.selfWatch}}
                    </td>
                </tr>
            </tbody>
        </table>
        <console-output log-url="_api.sdk.functionConsoleLog(model.invocation.id)" supports-incremental-updates="true"
                        is-running="isRunning(model.invocation)">
        </console-output>
    </div>
</div>

<div ng-show="children" class="row">
    <div class="col-md-9">
        <h3>Children <small>Functions triggered by this function</small></h3>
        <p ng-if="!children">Loading...</p>
        <section ng-if="children">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th class="col-md-3">Function Name</th>
                        <th class="col-md-1">Status</th>
                        <th class="col-md-2">Status Detail</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="child in children">
                        <td>
                            <a bind-once href="#functions/invocations/{{child.invocation.id}}">
                                {{child.invocation.functionDisplayTitle}}
                            </a>
                        </td>
                        <td>
                            <span ng-class="child.invocation.getLabelClass()" class="label">
                                {{child.invocation.getLabelText()}}
                            </span>
                        </td>
                        <td>
                            <span>{{child.invocation.statusTimeString}}</span> <small>({{child.invocation.durationString}} running time)</small>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="btn btn-primary btn-sm" ng-show="hasMoreChildren && !loadingChildren" ng-click="loadChildren()">Load more</button>
            <button type="button" class="btn btn-primary btn-sm" ng-show="loadingChildren">Loading ...</button>
        </section>
    </div>
</div>