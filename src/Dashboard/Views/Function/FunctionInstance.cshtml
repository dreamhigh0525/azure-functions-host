@using Dashboard.ViewModels
@using Newtonsoft.Json
@model FunctionInstanceDetailsViewModel

@{
    var isRunning = Model.Invocation.Status == FunctionInstanceStatus.Running;
    
    ViewBag.Title = "FunctionInstance";

    var log = Model.Invocation;
    var trigger = Model.TriggerReason;

    string alertClass = null;
    string alertHeader = null;
    switch (log.Status)
    {
        case FunctionInstanceStatus.CompletedFailed:
            alertClass = "alert-danger";
            alertHeader = "Failed";
            break;
        case FunctionInstanceStatus.CompletedSuccess:
            alertClass = "alert-success";
            alertHeader = "Completed";
            break;
        case FunctionInstanceStatus.NeverFinished:
            alertClass = "alert-warning";
            alertHeader = "Never Finished";
            break;
        case FunctionInstanceStatus.Running:
            alertClass = "alert-info";
            alertHeader = "Running";
            break;
        case FunctionInstanceStatus.Queued:
            alertClass = "alert-info";
            alertHeader = "Queued";
            break;
            // don't colorize others.     
    }
}

<ol class="breadcrumb">
    <li>@Html.ActionLink("Dashboard", "Index", "Dashboard")</li>
    <li>@Html.ActionLink(log.FunctionName, "FunctionInstances", "Function", new { functionName = log.FunctionFullName }, new { })</li>
</ol>

<div class="row">
    <div class="col-md-9">
        <h3>Invocation Details <small>@Model.Invocation.FunctionName</small></h3>
        
        @if (isRunning)
        {
            <p>
            @using (Html.BeginForm("Abort", "Function", new { id = Model.Invocation.Id }, FormMethod.Post, new { @class = "form-inline" }))
            {
                if (!Model.IsAborted)
                {
                    <button class="btn btn-danger btn-sm" type="submit"><span class="glyphicon glyphicon-remove"></span> Abort Host</button>
                }
                else
                {
                    <button class="btn btn-danger btn-sm" disabled>Host abort requested</button>
                }
            }
            </p>
        }
        
        <p class="alert @alertClass">
            @if (!String.IsNullOrEmpty(alertHeader))
            {
                <b>@alertHeader</b>
            }
            
            @if (log.WhenUtc.HasValue)
            {
                @MoreHtmlHelpers.DateTimeRelative(log.WhenUtc.Value)
            }

            @if (log.Duration.HasValue)
            {
                <span>(@MoreHtmlHelpers.TimeSpanRelative(log.Duration.Value))</span>
            }

            @if (!String.IsNullOrEmpty(log.ExceptionMessage))
            {
                <br/>
                <span>
                    <b>@log.ExceptionType</b>: @log.ExceptionMessage 
                </span>
            }
        </p>

        <p>@Html.ActionLink("Replay function", "Replay", new { parentId = Model.InvocationLogViewModel.Id }, new { @class = "btn btn-primary" })</p>

        <p>
            <span class="glyphicon glyphicon-flash"></span> @trigger.ToString()
            @if (Model.Ancestor != null)
            {
                <span> on @Html.ActionLink(Model.Ancestor.FunctionDisplayTitle, "FunctionInstance", "Function", new {id = Model.Ancestor.Id}, new {title = "The parent job which triggered this function" })</span>
            }
        </p>
        
        @if (Model.Parameters == null)
        {
            // the function is no more available, optionally display a message here
        }
        else
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th class="col-md-2">Parameter</th>
                        <th class="col-md-3">Value</th>
                        <th class="col-md-4">Notes</th>
                    </tr>
                </thead>
                <tbody>
                @if (!Model.Parameters.Any())
                {
                    <tr>
                        <td colspan="3">The function has no parameters.</td>
                    </tr>
                }
                @foreach (var param in Model.Parameters)
                {
                    <tr>
                        <td><b>@param.Name</b></td>
                        <td>
                            @if (param.ExtendedBlobModel != null)
                            {
                                if (!param.ExtendedBlobModel.IsBlobMissing)
                                {
                                    if (param.ExtendedBlobModel.IsOutput && !param.ExtendedBlobModel.IsBlobOwnedByCurrentFunctionInstance)
                                    {
                                        <span title="The existing blob was not generated by the current function invocation." class="glyphicon glyphicon-exclamation-sign not-running"></span>                                        
                                    }
                                    <a href="@Url.HttpRouteUrl("DefaultApi", new {controller = "Log", action = "Blob", path = param.ArgInvokeString})">@param.ArgInvokeString</a>
                                    if (!param.ExtendedBlobModel.IsBlobOwnedByCurrentFunctionInstance
                                        && param.ExtendedBlobModel.OwnerId != Guid.Empty)
                                    {
                                        <br/><br/>
                                        <span>The blob was generated by another 
                                            @Html.ActionLink("function invocation", "FunctionInstance", "Function", new { id = param.ExtendedBlobModel.OwnerId }, new { }).
                                        </span>
                                    }
                                } 
                                else
                                {
                                    @param.ArgInvokeString <text> - (The blob does not exist).</text>
                                }
                            }
                            else
                            {
                                @param.ArgInvokeString
                            }
                        </td>
                        <td>
                            @param.SelfWatch
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        }
    </div>

</div>

<button type="button" class="btn btn-primary btn-sm" data-toggle="collapse" data-target="#output">
    Toggle Output
</button>


<form id="output" class="collapse" role="form">
    
    @if (isRunning)
    {
        <div class="checkbox">
            <label>
                <input type="checkbox" id="auto-scroll" checked> Auto-scroll
            </label>
        </div>
    }
    
    <div class="form-group">
        <textarea id="output-body" rows="10" class="form-control">loading...</textarea>
        <span class="help-block">This represents the console output. It is automatically refreshed.</span>
    </div>
</form>

<script type="text/javascript">
    $(function () {
        var paused = true;
        var output = $('#output-body');
        var url = '@Url.HttpRouteUrl("DefaultApi", new { controller = "Log", action = "Output", id = Model.Invocation.Id })';
        var isRunning = @(isRunning ? "true" : "false")
            
        $('#output').on('shown.bs.collapse', function (e) {
            $.ajax({
                url: url,
                cache: false,
                data: {
                    start: 0
                },
                success: function(result) {
                    output.text(result);
                }
            });

            paused = false;
        });

        $('#output').on('hidden.bs.collapse', function (e) {
            // disable auto-refresh
            paused = true;
        });
        
        var iID = setInterval(function () {
            
            if (!paused && isRunning) {
                var currentLines = output.text().split(/\n/).length;

                $.ajax({
                    type: 'GET',
                    url: url,
                    async: true,
                    cache: false,
                    data: {
                        start: currentLines
                    },
                    success: function (data) {
                        // append the text
                        if (data.length > 0) {
                            output.append('\n' + data);
                        }

                        // scroll to bottom
                        if ($('#auto-scroll:checked').length > 0) {
                            output.scrollTop(output[0].scrollHeight - output.height());
                        }
                    },
                    fail: function (result) {
                    }
                });
            }

            var stopRequested = false;
            if (stopRequested) {
                clearInterval(iID);
            }

        }, 5000);
        
        $('a').tooltip();
    });  
</script>

@if (Model.ChildrenIds.Any())
{
    <div class="row">
        <div class="col-md-9">
            <h3>Children <small>Functions triggered by this function</small></h3>
            <table id="invocationChildren" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th class="col-md-3">Function Name</th>
                        <th class="col-md-1">Status</th>
                        <th class="col-md-2">Status Detail</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <button type="button" id="loadMoreChildren" class="btn btn-primary btn-sm" data-toggle="collapse" style="display:none;">
            </button>
            <script>
                $(function () {
                    var url = '@Url.RouteUrl(new { controller = "Function", action = "InvocationsByIds" })';
                    var children = @(Html.Raw(JsonConvert.SerializeObject(Model.ChildrenIds, Formatting.Indented)));
                    var button = $('#loadMoreChildren');
                    var buttonText = "Load more";
                    var buttonLoadingText = "Loading ...";
                    var table = $('#invocationChildren');
                    var pageSize = 5;
                    function disableLoadingButton() {
                        button.disabled = true;
                        button.text(buttonLoadingText);
                        button.show();
                    }
                    function enableLoadingButton() {
                        button[0].disabled = false;
                        button.text(buttonText);
                        button.show();
                    }
                    function nextPage() {
                        var upcoming = children.splice(0, pageSize);
                        disableLoadingButton();
                        $.ajax({
                            type: 'POST',
                            url: url,
                            cache: false,
                            contentType: "application/json",
                            data: JSON.stringify({ invocationIds: upcoming }) 
                        }).done(function(data) {
                            table.find('tbody').append(data);
                            $(document).scrollTop($(document).height() - table.height());
                            if (children.length > 0) {
                                enableLoadingButton();
                            } else {
                                button.hide();
                            }
                        }).fail(function(xhr, status, err) {
                            enableLoadingButton();
                        });
                    }

                    button.click(nextPage);
                    nextPage();
                });
            </script>
        </div>
    </div>
}